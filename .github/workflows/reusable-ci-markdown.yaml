# Reusable workflow for Markdown CI linting
# This workflow runs markdownlint to check Markdown files quality and formatting
name: reusable-ci-markdown

on:
  workflow_call:
    inputs:
      component:
        description: "Logical component name (e.g. go-common)"
        required: true
        type: string
      environment:
        description: "Target environment (dev, qa, stg, prd, etc.)"
        required: true
        type: string

env:
  COMPONENT: ${{ inputs.component }}
  ENVIRONMENT: ${{ inputs.environment }}

jobs:
  lint:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure git auth
        if: github.event_name == 'pull_request'
        uses: ./.github/actions/git-auth
        with:
          operation: configure
          token: ${{ github.token }}

      - name: Exec markdownlint with reviewdog (PR comments)
        if: github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
        uses: reviewdog/action-markdownlint@3667398db9118d7e78f7a63d10e26ce454ba5f58 # v0.26.2
        with:
          fail_level: error
          filter_mode: file
          github_token: ${{ github.token }}
          level: error
          markdownlint_flags: "README*.md"
          reporter: github-pr-review

      - name: Clear git auth
        if: always() && github.event_name == 'pull_request'
        uses: ./.github/actions/git-auth
        with:
          operation: clear
          token: ${{ github.token }}

      - name: Exec markdownlint-cli2 (non-PR)
        if: github.event_name != 'pull_request'
        uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101 # v22.0.0
        with:
          config: ".markdownlint.yaml"
          fix: false
          globs: "README*.md"

      - name: Post PR failure comment
        if: failure() && github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = `‚ùå Markdownlint failed for component: ${process.env.COMPONENT} (environment: ${process.env.ENVIRONMENT})\n\n`+
              `Run page: ${runUrl}\n\n`+
              `See inline PR review comments from markdownlint (via reviewdog) for details.\n\n`+
              `Re-run guidance:\n- Fix markdown issues locally\n- Commit & push to trigger CI again.`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Summary
        if: always()
        uses: ./.github/actions/summary
        with:
          artifacts: |
            (none)
          outputs: |
            (none)
          params: |
            component: ${{ env.COMPONENT }}
            environment: ${{ env.ENVIRONMENT }}
          status: "${{ job.status }}"
          title: "Markdownlint"
